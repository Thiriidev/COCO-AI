<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>iOS Role Based App with S3 Upload</title>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1410.0.min.js"></script>
  <style>
    :root {
      --bg: #f2f2f7;
      --text: #111;
      --card-bg: #fff;
      --bot-bg: #e9e9ef;
      --user-bg: #007aff;
    }
    body.dark {
      --bg: #000;
      --text: #fefefe;
      --card-bg: #1c1c1e;
      --bot-bg: #2c2c2e;
      --user-bg: #0a84ff;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .iphone {
      width: 430px;
      height: 932px;
      background: var(--bg);
      border-radius: 20px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .statusbar {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
    }
    #clock { font-weight: 700; }
    .status-icons {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .battery {
      width: 24px;
      height: 12px;
      border: 2px solid var(--text);
      border-radius: 3px;
      position: relative;
      display: inline-block;
    }
    .battery::after {
      content: "";
      position: absolute;
      top: 2px;
      right: -5px;
      width: 3px;
      height: 6px;
      background: var(--text);
      border-radius: 1px;
    }
    .battery-fill {
      height: 100%;
      width: 70%;
      background: var(--text);
      border-radius: 1px;
    }
    header {
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
      background: var(--card-bg);
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
      position: relative;
    }
    header .center {
      position: absolute;
      left: 0; right: 0;
      text-align: center;
      pointer-events: none;
    }
    header button {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--user-bg);
    }
    #logoutBtn {
      color: #ff3b30;
      font-weight: bold;
      font-size: 20px;
    }
    main {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .hidden { display: none; }
    .title { text-align: center; font-size: 20px; font-weight: 700; margin: 20px 0; color: var(--text); }
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      padding: 24px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: transform 0.2s;
      color: var(--text);
    }
    .card:active { transform: scale(0.97); }
    .card svg { width: 40px; height: 40px; fill: var(--user-bg); margin-bottom: 10px; }
    .card p { margin: 0; font-weight: 600; font-size: 16px; color: var(--text); }
    .chat-box { display: flex; flex-direction: column; height: 100%; }
    .messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 720px;
    }
    .bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.4;
    }
    .bot { background: var(--bot-bg); align-self: flex-start; color: var(--text); }
    .user { background: var(--user-bg); color: #fff; align-self: flex-end; }
    .typing {
      background: var(--bot-bg);
      align-self: flex-start;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 15px;
      max-width: 60px;
      color: var(--text);
    }
    .dot {
      height: 6px;
      width: 6px;
      margin: 0 2px;
      background-color: #aaa;
      border-radius: 50%;
      display: inline-block;
      animation: blink 1.4s infinite both;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0% { opacity: .2; }
      20% { opacity: 1; }
      100% { opacity: .2; }
    }
    .chat-input {
      display: flex;
      padding: 8px 12px;
      border-top: 0.5px solid rgba(0,0,0,0.1);
      background: var(--card-bg);
    }
    .chat-input input {
      flex: 1;
      padding: 10px 12px;
      border: none;
      border-radius: 20px;
      outline: none;
      background: var(--bg);
      color: var(--text);
    }
    .chat-input button {
      margin-left: 8px;
      background: var(--user-bg);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 6px 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .report-btn {
      background: #ff3b30;
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 10px;
      margin: 10px;
      font-size: 15px;
      cursor: pointer;
    }
    .upload-container { text-align: center; }
    .upload-btn {
      background: var(--user-bg);
      color: #fff;
      border: none;
      border-radius: 22px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .file-list {
      margin-top: 16px;
      font-size: 15px;
      text-align: left;
      color: var(--text);
    }
    .file-item {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }
    textarea {
      width: calc(100% - 24px);
      min-height: 120px;
      border: 1px solid #ccc;
      border-radius: 14px;
      padding: 12px;
      outline: none;
      font-size: 15px;
      background: var(--bg);
      color: var(--text);
      box-sizing: border-box;
    }
    .btn {
      background: var(--user-bg);
      color: #fff;
      border: none;
      border-radius: 22px;
      padding: 12px;
      margin-top: 14px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      font-weight: 600;
    }
    .chatbot-card {
      background: var(--user-bg);
      border-radius: 50%;
      width: 72px;
      height: 72px;
      margin: 24px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      transition: transform 0.2s;
    }
    .chatbot-card:active { transform: scale(0.92); }
    .chatbot-card svg {
      width: 32px;
      height: 32px;
      fill: #fff;
    }
  </style>
</head>
<body>
  <div class="iphone">
    <!-- Status Bar -->
    <div class="statusbar">
      <span id="clock">--:--</span>
      <div class="status-icons">
        üì∂ üì° 
        <div class="battery"><div class="battery-fill"></div></div>
      </div>
    </div>

    <!-- Nav Bar -->
    <header>
      <button id="backBtn" onclick="goBack()">‚Äπ</button>
      <span class="center" id="header">Select Role</span>
      <div>
        <button id="themeBtn" onclick="toggleTheme()">‚òÄÔ∏è</button>
        <button id="logoutBtn" class="hidden" onclick="logout()">‚éã</button>
      </div>
    </header>

    <!-- Main -->
    <main>
      <!-- Role Selection -->
      <section id="role-screen">
        <div class="title">Choose your role</div>
        <div class="card" onclick="goManager()">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="3"/><path d="M4 20c0-3.3 2.7-6 6-6h4c3.3 0 6 2.7 6 6"/></svg>
          <p>Manager / HR</p>
        </div>
        <div class="card" onclick="goStaff()">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="7" r="3"/><path d="M6 21v-3a6 6 0 0112 0v3"/></svg>
          <p>Staff</p>
        </div>
      </section>

      <!-- Login Screen -->
      <section id="login-screen" class="hidden">
        <div class="title">Manager / HR Login</div>
        <div style="text-align:center; max-width:280px; margin:0 auto;">
          <input type="text" id="loginUser" placeholder="Username"
                 style="width:100%; padding:10px; margin-bottom:10px; border-radius:14px; border:1px solid #ccc; font-size:15px;">
          <input type="password" id="loginPass" placeholder="Password"
                 style="width:100%; padding:10px; margin-bottom:10px; border-radius:14px; border:1px solid #ccc; font-size:15px;">
          <button class="btn" onclick="validateLogin()">Login</button>
          <p id="loginError" style="color:red; font-size:14px; display:none;">Invalid credentials</p>
        </div>
      </section>

      <!-- HR / Manufacturing -->
      <section id="dept-screen" class="hidden">
        <div class="title">Select Department</div>
        <div class="card" onclick="openUpload('HR')">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="3"/><path d="M4 20c0-3.3 2.7-6 6-6h4c3.3 0 6 2.7 6 6"/></svg>
          <p>HR</p>
        </div>
        <div class="card" onclick="openUpload('MANUFACTURE')">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="7" r="3"/><path d="M6 21v-3a6 6 0 0112 0v3"/></svg>
          <p>Manufacturing</p>
        </div>
      </section>

      <!-- Upload Page -->
      <section id="upload-screen" class="hidden">
        <div class="title" id="upload-title"></div>
        <div class="upload-container">
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Upload File</button>
          <input type="file" id="fileInput" multiple class="hidden">
        </div>
        <div class="file-list" id="fileList"></div>
        <div class="chatbot-card" onclick="goToChatbot()">
          <svg viewBox="0 0 24 24"><path d="M4 4h16v12H5.17L4 17.17V4z"/></svg>
        </div>
      </section>

      <!-- Chatbot -->
      <section id="chatbot-screen" class="hidden">
        <div class="chat-box">
          <div class="messages" id="chatMessages">
            <div class="bubble bot">Hi, I'm your assistant. How can I help?</div>
          </div>
          <button class="report-btn hidden" id="reportBtn" onclick="openReport()">Report a Problem</button>
          <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
          </div>
        </div>
      </section>

      <!-- Report -->
      <section id="report-screen" class="hidden">
        <div class="title">Report a Problem</div>
        <textarea placeholder="Describe the issue..."></textarea>
        <button class="btn" onclick="submitReport()">Submit</button>
      </section>
    </main>
  </div>

<script>
  const header = document.getElementById('header');
  const backBtn = document.getElementById('backBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const reportBtn = document.getElementById('reportBtn');
  const screens = {
    role: document.getElementById('role-screen'),
    login: document.getElementById('login-screen'),
    dept: document.getElementById('dept-screen'),
    upload: document.getElementById('upload-screen'),
    chatbot: document.getElementById('chatbot-screen'),
    report: document.getElementById('report-screen')
  };
  let historyStack = [];
  let currentDept = null;

  // üîπ Global sessionId (shared with Lambda + Lex)
  let sessionId = null;

  // Preset login credentials
  const validUser = "admin";
  const validPass = "1234";

  // AWS config
  AWS.config.region = 'ap-southeast-2';
  AWS.config.credentials = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: 'ap-southeast-2:b93224ac-d984-41ae-9ee9-c85c95ffb702'
  });

  var lexruntime = new AWS.LexRuntimeV2();
  var s3 = new AWS.S3({ apiVersion: "2006-03-01", params: { Bucket: "cocomelon25" } });

  // üîπ Generate sessionId at login
  function generateSessionId(username) {
    sessionId = "webuser-" + username + "-" + Date.now();
    console.log("Session ID set:", sessionId);
  }

  function show(screen) {
    Object.values(screens).forEach(s => s.classList.add('hidden'));
    screens[screen].classList.remove('hidden');
    header.innerText = {
      role: "Select Role",
      login: "Login",
      dept: "Departments",
      upload: "Upload Files",
      chatbot: "Chatbot",
      report: "Report"
    }[screen];
    backBtn.style.visibility = historyStack.length ? "visible" : "hidden";
    logoutBtn.classList.toggle("hidden", !(screen === "dept" || screen === "upload"));
  }

  function goManager() { historyStack.push("role"); show('login'); }

  function validateLogin() {
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    if (user === validUser && pass === validPass) {
      document.getElementById("loginError").style.display = "none";
      generateSessionId(user);  // ‚úÖ create sessionId here
      historyStack.push("login");
      show('dept');
    } else {
      document.getElementById("loginError").style.display = "block";
    }
  }

  function goStaff() {
    generateSessionId("staff");  // ‚úÖ staff gets a session too
    historyStack.push("role");
    show('chatbot');
  }

  function openUpload(folder) {
    historyStack.push("dept");
    currentDept = folder;
    show('upload');
    document.getElementById('upload-title').innerText = folder + " Folder";
  }
  function goToChatbot() { historyStack.push("upload"); show('chatbot'); }
  function goBack() { if(historyStack.length) show(historyStack.pop()); }
  function logout() { historyStack = []; show('role'); }

  // üîπ File upload with sessionId metadata
  document.getElementById('fileInput').addEventListener('change', (e)=>{ handleFileUpload(e.target.files); });
  function handleFileUpload(files) {
    const list = document.getElementById('fileList');
    list.innerHTML = "";
    Array.from(files).forEach(file => {
// Force upload to match Bedrock KB S3 prefixes
let prefix = "";
if (currentDept === "HR") {
  prefix = "HR/";  // Bedrock KB data source prefix for HR
} else if (currentDept === "MANUFACTURE") {
  prefix = "Manufacture/";  // Bedrock KB data source prefix for Manufacturing
}

var key = prefix + Date.now() + "_" + file.name;
      var params = {
        Key: key,
        Body: file,
        ContentType: file.type,
        Metadata: { sessionid: sessionId }   // ‚úÖ attach sessionId here
      };
      s3.upload(params, function(err, data) {
        const div = document.createElement('div');
        div.className = "file-item";
        if (err) {
          div.innerHTML = "üìÑ " + file.name + " ‚ùå (Upload Failed)";
        } else {
          div.innerHTML = "üìÑ " + file.name + " ‚úÖ";
        }
        list.appendChild(div);
      });
    });
  }

  // Chatbot
  function appendMessage(sender, text) {
    const messages = document.getElementById('chatMessages');
    const bubble = document.createElement('div');
    bubble.className = "bubble " + sender;
    bubble.innerText = text;
    messages.appendChild(bubble);
    messages.scrollTop = messages.scrollHeight;
  }
  function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    appendMessage("user", text);
    input.value = "";
    const typing = document.createElement('div');
    typing.className = "typing";
    typing.innerHTML = "<span class='dot'></span><span class='dot'></span><span class='dot'></span>";
    document.getElementById('chatMessages').appendChild(typing);

    var params = { 
      botId: "2O17D8PB8H", 
      botAliasId: "SXQAULZ0PM", 
      localeId: "en_US", 
      sessionId: sessionId,   // ‚úÖ always use global sessionId
      text: text 
    };
    lexruntime.recognizeText(params, function(err, data) {
      typing.remove();
      if (err) { appendMessage("bot", "Error: " + err.message); }
      else {
        var messages = data.messages || [];
        if (!messages.length) appendMessage("bot", "(No response)");
        messages.forEach(function(msg) { appendMessage("bot", msg.content); });
        if (/report|problem/i.test(text)) reportBtn.classList.remove('hidden');
      }
    });
  }

  // Report
  function openReport() { historyStack.push("chatbot"); show('report'); }
  function submitReport() {
    appendMessage("user", "Problem reported: " + document.querySelector('#report-screen textarea').value);
    goBack();
  }

  // Theme
  function toggleTheme() { document.body.classList.toggle("dark"); }

  // Clock
  function updateClock() {
    const now = new Date();
    const hrs = now.getHours().toString().padStart(2,"0");
    const mins = now.getMinutes().toString().padStart(2,"0");
    document.getElementById('clock').innerText = `${hrs}:${mins}`;
  }
  setInterval(updateClock, 1000);
  updateClock();
  show('role');
</script>
</body>
</html>
